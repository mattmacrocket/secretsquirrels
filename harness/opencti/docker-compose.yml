services:
  redis:
    image: redis:8.4.0
    restart: always
    volumes:
      - redisdata:/data

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.19.9
    restart: always
    volumes:
      - esdata:/usr/share/elasticsearch/data
    environment:
      - discovery.type=single-node
      - xpack.ml.enabled=false
      - xpack.security.enabled=false
      - thread_pool.search.queue_size=5000
      - logger.org.elasticsearch.discovery=ERROR
      - ES_JAVA_OPTS=-Xms${ELASTIC_MEMORY_SIZE} -Xmx${ELASTIC_MEMORY_SIZE}
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://elasticsearch:9200/_cluster/health?wait_for_status=yellow >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 50

  minio:
    image: minio/minio:RELEASE.2025-06-13T11-33-47Z
    restart: always
    command: server /data
    ports:
      - "${MINIO_PORT}:9000"
    volumes:
      - s3data:/data
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}

  rabbitmq:
    image: rabbitmq:4.2-management
    restart: always
    volumes:
      - amqpdata:/var/lib/rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
      - RABBITMQ_NODENAME=rabbit01@localhost

  opencti:
    image: opencti/platform:${OPENCTI_VERSION}
    restart: always
    ports:
      - "${OPENCTI_PORT}:8080"
    depends_on:
      elasticsearch:
        condition: service_healthy
      minio:
        condition: service_started
      rabbitmq:
        condition: service_started
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://opencti:8080/health?health_access_key=${OPENCTI_HEALTHCHECK_ACCESS_KEY}"]
      interval: 15s
      timeout: 5s
      retries: 30
    environment:
      - NODE_OPTIONS=--max-old-space-size=8096
      - APP__PORT=8080
      - APP__BASE_URL=${OPENCTI_EXTERNAL_SCHEME}://${OPENCTI_HOST}:${OPENCTI_PORT}
      - APP__ADMIN__EMAIL=${OPENCTI_ADMIN_EMAIL}
      - APP__ADMIN__PASSWORD=${OPENCTI_ADMIN_PASSWORD}
      - APP__ADMIN__TOKEN=${OPENCTI_ADMIN_TOKEN}
      - APP__HEALTH_ACCESS_KEY=${OPENCTI_HEALTHCHECK_ACCESS_KEY}
      - PROVIDERS__LOCAL__STRATEGY=LocalStrategy
      - REDIS__HOSTNAME=redis
      - REDIS__PORT=6379
      - ELASTICSEARCH__URL=http://elasticsearch:9200
      - ELASTICSEARCH__NUMBER_OF_REPLICAS=0
      - MINIO__ENDPOINT=minio
      - MINIO__PORT=9000
      - MINIO__USE_SSL=false
      - MINIO__ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO__SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - RABBITMQ__HOSTNAME=rabbitmq
      - RABBITMQ__PORT=5672
      - RABBITMQ__PORT_MANAGEMENT=15672
      - RABBITMQ__MANAGEMENT_SSL=false
      - RABBITMQ__USERNAME=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ__PASSWORD=${RABBITMQ_DEFAULT_PASS}
      - SMTP__HOSTNAME=${SMTP_HOSTNAME}
      - SMTP__PORT=25

  worker:
    image: opencti/worker:${OPENCTI_VERSION}
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}

  connector-opencti:
    image: opencti/connector-opencti:${OPENCTI_VERSION}
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_OPENCTI_ID}
      - CONNECTOR_NAME=OpenCTI Datasets
      - CONNECTOR_SCOPE=marking-definition,identity,location
      - CONNECTOR_AUTO_CREATE_SERVICE_ACCOUNT=true
      - CONNECTOR_AUTO_CREATE_SERVICE_ACCOUNT_CONFIDENCE_LEVEL=100

  connector-mitre:
    image: opencti/connector-mitre:${OPENCTI_VERSION}
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_MITRE_ID}
      - CONNECTOR_NAME=MITRE ATT&CK
      - CONNECTOR_SCOPE=identity,marking-definition,attack-pattern,campaign,course-of-action,intrusion-set,malware,tool,x-mitre-matrix,x-mitre-tactic,x-mitre-data-source,x-mitre-data-component
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_AUTO_CREATE_SERVICE_ACCOUNT=true
      - CONNECTOR_AUTO_CREATE_SERVICE_ACCOUNT_CONFIDENCE_LEVEL=75
      - MITRE_INTERVAL=${MITRE_INTERVAL_DAYS}
      - MITRE_ENTERPRISE_FILE_URL=${MITRE_ENTERPRISE_FILE_URL}
      - MITRE_MOBILE_ATTACK_FILE_URL=${MITRE_MOBILE_ATTACK_FILE_URL}
      - MITRE_ICS_ATTACK_FILE_URL=${MITRE_ICS_ATTACK_FILE_URL}
      - MITRE_CAPEC_FILE_URL=${MITRE_CAPEC_FILE_URL}

  connector-taxii2:
    image: opencti/connector-taxii2:${OPENCTI_VERSION}
    restart: always
    profiles: ["clownpeanuts"]
    depends_on:
      opencti:
        condition: service_healthy
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_TAXII2_ID}
      - CONNECTOR_NAME=ClownPeanuts TAXII2
      - CONNECTOR_SCOPE=indicator,attack-pattern,relationship,ipv4-addr
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_DURATION_PERIOD=${CONNECTOR_TAXII2_DURATION_PERIOD}
      - TAXII2_DISCOVERY_URL=${CLOWNPEANUTS_TAXII_DISCOVERY_URL}
      - TAXII2_V21=true
      - TAXII2_COLLECTIONS=*.*
      - TAXII2_INITIAL_HISTORY=${TAXII2_INITIAL_HISTORY_HOURS}
      - TAXII2_VERIFY_SSL=${TAXII2_VERIFY_SSL}
      - TAXII2_CREATE_INDICATORS=true
      - TAXII2_CREATE_OBSERVABLES=true
      - TAXII2_ADD_CUSTOM_LABEL=true
      - TAXII2_CUSTOM_LABEL=clownpeanuts
      - TAXII2_CREATE_AUTHOR=true
      - TAXII2_AUTHOR_NAME=ClownPeanuts TAXII Feed
      - TAXII2_AUTHOR_DESCRIPTION=ClownPeanuts deception telemetry TAXII feed

volumes:
  amqpdata:
  esdata:
  redisdata:
  s3data:
